<!DOCTYPE html>
<html>
  <head>
  <title>Bike Sharing configuration for Pebble</title>
  <link rel='stylesheet' type='text/css' href='css/slate.min.css'>
  <script src='js/slate.min.js'></script>
  <style>
  .title {
    padding: 15px 10px;
    text-transform: uppercase;
    font-family: 'PT Sans', sans-serif;
    font-size: 1.2em;
    font-weight: 500;
    color: #888888;
    text-align: center;
  }
  </style>
  </head>

  <body>
    <h1 class='title'>Bike Sharing</h1>

    <div class='item-container'>
      <div class='item-container-content'>
        <div class='item'>
          Enter the api address for your bike sharing service.
        </div>
      </div>
    </div>

    <div class='item-container'>
      <div class='item-container-header'>API address.</div>
      <div class='item-container-content'>
        <label class="item">
            Location :
          <!-- <div class="item-input-wrapper"> -->
            <!-- <input type="text" class="item-input" name="api_address" id='api_address' placeholder="API address"> -->
            <select id='stationList' class"'item-select">
            </select>
          <!-- </div> -->
        </label>
      </div>
      <div class='item-container-footer'>
        Go to "http://api.citybik.es/v2/networks/" to find your API address.
      </div>
    </div>

    <div class='item-container'>
      <div class='button-container'>
        <input id='submit_button' type='button' class='item-button' value='SUBMIT'>
      </div>
    </div>
  </body>
  <script>
  function getConfigData() {
    var select = document.getElementById('stationList');
    var apiAddress = select.options[select.selectedIndex].value;

    console.log('Sending API address : ' + apiAddress + ' from ' + JSON.stringify(select.options));

    var options = {
      'api_address': apiAddress,
    };

    // Save for next launch
    localStorage['api_address'] = options['api_address'];

    //console.log('Got options: ' + JSON.stringify(options));
    return options;
  }

  function getQueryParam(variable, defaultValue) {
    var query = location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
      var pair = vars[i].split('=');
      if (pair[0] === variable) {
        return decodeURIComponent(pair[1]);
      }
    }
    return defaultValue || false;
  }

  var send = function() {
    var return_to = getQueryParam('return_to', 'pebblejs://close#');
    document.location = return_to + encodeURIComponent(JSON.stringify(getConfigData()));
  }

  var submitButton = document.getElementById('submit_button');
  submitButton.addEventListener('click', function() {
    console.log('Submit');

    // Set the return URL depending on the runtime environment
    send()
  });

  var calc_distance = function (lat1, long1, lat2, long2) {
      var radlat1 = Math.PI * lat1 / 180;
      var radlat2 = Math.PI * lat2 / 180;
      var radlon1 = Math.PI * long1 / 180;
      var radlon2 = Math.PI * long2 / 180;

      var theta = long1 - long2;
      var radtheta = ( Math.PI * theta ) / 180;

      var dist = ( Math.sin(radlat1) * Math.sin(radlat2) ) + ( Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta) );
      dist = Math.acos(dist);
      dist = dist * 180 / Math.PI;
      dist = dist * 60 * 1.1515;

      return dist;
  };


  (function () {
      var results = [];
      navigator.geolocation.getCurrentPosition(function(pos) {
        var min = 1000000000;
        var minObj = {};
        var xhr = new XMLHttpRequest();

        xhr.open('GET', 'http://api.citybik.es/v2/networks/');
        xhr.onreadystatechange = function() {
            if (!(xhr.readyState == 4 && xhr.status == 200)) {
                console.log('xhr.status : ' + xhr.status);
                return;
            }

            var json = JSON.parse(xhr.responseText);

            for (var i = 0; i < json['networks'].length; ++i) {
                var dist = calc_distance(json['networks'][i]['location']['latitude'],
                        json['networks'][i]['location']['longitude'],
                        pos.coords.latitude,
                        pos.coords.longitude);
                if (dist < min) {
                    min = dist;
                    minObj = {
                        'name' : json['networks'][i]['name'],
                        'url' : 'http://api.citybik.es/' + json['networks'][i]['href'],
                    };
                }

                results.push({
                    'name' : json['networks'][i]['name'],
                    'url' : 'http://api.citybik.es/' + json['networks'][i]['href'],
                });
            }

            console.log('Min is ' + JSON.stringify(minObj));

            results.sort(function(a, b) {
                var nameA = a.name.toLowerCase()
                var nameB = b.name.toLowerCase()
                if (nameA < nameB) {
                    return -1
                } else if (nameA > nameB) {
                    return 1
                } else {
                    return 0
                }
            });


            var select = document.getElementById('stationList');

            var option = document.createElement('option');
            option.appendChild( document.createTextNode(minObj.name) );
            option.value = minObj.url;
            select.add(option);

            for (var i = 0; i < results.length; ++i) {
                option = document.createElement('option');
                option.appendChild( document.createTextNode(results[i].name) );
                option.value = results[i].url;
                select.add(option);
            }
        }
        xhr.send();
      }, function (err) {
          console.log(err);
      });

  })();

  (function() {
    var apiAddress = document.getElementById('api_address');

    // Load any previously saved configuration, if available
    if(localStorage['api_address']) {
      apiAddress.value = localStorage['api_address'];
    }
  })();
  </script>
</html>
